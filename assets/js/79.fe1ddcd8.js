(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{211:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"pm2-自动化部署-node-项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pm2-自动化部署-node-项目"}},[s._v("#")]),s._v(" pm2 自动化部署 Node 项目")]),s._v(" "),a("p",[s._v("使用 pm2 deploy 来实现 Node 项目自动部署。")]),s._v(" "),a("blockquote",[a("p",[s._v("个人项目，加上是最低配的阿里云服务器，因此采用这个。公司项目可以上 K8S + Docker 。")])]),s._v(" "),a("h2",{attrs:{id:"零、如何启动项目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#零、如何启动项目"}},[s._v("#")]),s._v(" 零、如何启动项目")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 本地安装pm2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -g pm2\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/zhongxia245/pm2-depoly-node-demo.git\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" pm2-depoly-node-demo\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 复制 pm2 部署配置模板，并改成自己服务器信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" deploy.yaml.bak deploy.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" start\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如何部署")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第一次部署")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run server:setup\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新部署")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run server:update\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("h2",{attrs:{id:"一、服务器前置条件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、服务器前置条件"}},[s._v("#")]),s._v(" 一、服务器前置条件")]),s._v(" "),a("blockquote",[a("p",[s._v("这里以 github 仓库为例, 云服务器系统为 CentOS 7")]),s._v(" "),a("p",[s._v("如果不知道是什么系统，执行 "),a("code",[s._v("lsb_release -a")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("xxxx@iz2zehejz8ufzy9vmvt9xlz ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("$ lsb_release -a\nLSB Version:\t:core-4.1-amd64:core-4.1-noarch\nDistributor ID:\tCentOS\nDescription:\tCentOS Linux release "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.5")]),s._v(".1804 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Core"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nRelease:\t"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7.5")]),s._v(".1804\nCodename:\tCore\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])]),s._v(" "),a("ol",[a("li",[a("p",[s._v("安装 pm2 、git")]),s._v(" "),a("p",[a("code",[s._v("pm2 deploy")]),s._v(" 会在 服务器上自动去 "),a("code",[s._v("git fetch")]),s._v(" 仓库代码，因此需要服务器安装 "),a("code",[s._v("git")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -g pm2\n\nyum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("生成密钥")]),s._v(" "),a("p",[s._v("服务器下载 git 仓库的时候，会提示让你输入帐号密码，如何避免这个提示呢？使用 ssh 实现免密下载。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ssh-keygen -t rsa -C "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xxx@xxx.com"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("在 github 设置 ssh key")]),s._v(" "),a("p",[s._v("登录到GitHub，点击右上方的头像，选择settings ，点击Add SSH key，把id_rsa.pub的内容复制到里面即可。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://tva1.sinaimg.cn/large/006tNbRwly1gah73l7nj5j313i0jgwmk.jpg",alt:"image-20200101173601082"}})])])]),s._v(" "),a("h2",{attrs:{id:"二、如何部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、如何部署"}},[s._v("#")]),s._v(" 二、如何部署")]),s._v(" "),a("p",[a("code",[s._v("pm2 depoly")]),s._v(" 原理是 登录 "),a("code",[s._v("deploy.yaml")]),s._v(" 配置的服务器群，自动执行一些命令，来重新部署。")]),s._v(" "),a("blockquote",[a("p",[s._v("这里例子中，就是 拉取 git仓库的最新代码，然后重新启动 pm2")])]),s._v(" "),a("p",[s._v("因此，每次部署前，都需要把本地的代码提交到 git 仓库。")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 第一次部署")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run server:setup\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新部署")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" run server:update\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"三、常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、常见问题"}},[s._v("#")]),s._v(" 三、常见问题")]),s._v(" "),a("h3",{attrs:{id:"_1、ssh-端口号不是22的，如何配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1、ssh-端口号不是22的，如何配置"}},[s._v("#")]),s._v(" 1、ssh 端口号不是22的，如何配置")]),s._v(" "),a("p",[a("code",[s._v("port")]),s._v(" 字段必须为字符串，否则不生效。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apps")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ./bin/www "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 入口文件")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pm2-depoly-node"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 程序名称")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 环境变量")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("COMMON_VARIABLE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env_production")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" production\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署脚本")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("production")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生产环境")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" xxxxx "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器的用户名")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" www.xxxxx.com "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 服务器的ip地址")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1234"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh端口,必须为字符串，否则不生效")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ref")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" origin/master "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 要拉取的git分支")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ssh_options")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" StrictHostKeyChecking=no "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# SSH 公钥检查")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("repo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//github.com/zhongxia245/pm2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("depoly"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("demo.git "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 远程仓库地址")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /home/zhongxia/pm2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deploy/pm2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("deploy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("demo "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 拉取到服务器某个目录下")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pre-deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" git fetch "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("all "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署前执行")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("post-deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cnpm install &&  pm2 reload deploy.yaml "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("env production "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 部署后执行")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("NODE_ENV")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" production\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h3",{attrs:{id:"_2、fatal-could-not-read-from-remote-repository"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2、fatal-could-not-read-from-remote-repository"}},[s._v("#")]),s._v(" 2、fatal: Could not read from remote repository")]),s._v(" "),a("p",[s._v("报这个错，就是服务器没有 "),a("code",[s._v("clone")]),s._v(" 仓库的权限，遇到这个问题，按照上面"),a("strong",[s._v("服务器前置条件")]),s._v("的操作，配置 ssh 即可。")]),s._v(" "),a("h2",{attrs:{id:"终、参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#终、参考文章"}},[s._v("#")]),s._v(" 终、参考文章")]),s._v(" "),a("blockquote",[a("p",[s._v("主要是学习参考这个文章，然后实现这个一个 DEMO项目。")])]),s._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://juejin.im/post/5b823506e51d4538d517662f",target:"_blank",rel:"noopener noreferrer"}},[s._v("使用 pm2 自动化部署 node 项目"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);